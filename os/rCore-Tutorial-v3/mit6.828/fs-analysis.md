# xv6 文件系统分析

这回重新来照着文档和代码分析一下 xv6 文件系统。最好照着他重写一下 Tutorial 的文件系统。

## 文件系统层次结构

自下而上，层级分别是：

磁盘层：负责块的读写。

块缓存层：因为直接读写磁盘的速度很慢，所以将一些磁盘块缓存在内存中，并在适当的时候将修改同步回磁盘。注意，对于一个特定的块缓存，同一时间只有一个执行流可以对它进行修改。现在，上面的层只需考虑读写块缓存就好了，这是一个相比直接读写磁盘块速度更快的接口。

日志层：文件系统的一次操作需要写入多个块。期间掉电或者系统崩溃的话会导致磁盘上的内容不能构成一个合法的文件系统。因此需要将一次文件系统操作对应的多个块的写入封装成一个满足某种原子性事务。现在，上面的层只要在适当的地方插入 prologue 和 epilogue，就能保证中间的若干次块缓存写入是一个原子性事务了。

索引节点层：这一层正式引入文件的概念。所谓的文件就是一段数据，可能分为多个数据块保存在磁盘上。此时就需要索引节点 inode 来对数据块进行管理。每个 inode 内保存文件的编号 i-number 以及文件数据所在的数据块的索引。所有的 inode 都保存在磁盘一个固定的区域之内。现在，我们可以通过 i-number 来区分不同的文件，并可以读写它们的数据。文件系统呈现一个并列结构。

目录层：目录是一种特殊的文件。它的数据格式为一个 dirent 序列，每个 dirent 表示该目录下的一个子文件或者子目录，记录它的名字和 i-number。有了目录之后，我们就已经在磁盘上建立起一个树形文件系统了。
路径层：相比上一层变化不大，只是更加显式的表明我们可以通过一个绝对路径来找到一个文件对应的 inode，并读写里面的数据。现在，我们通过路径即可获取 inode 并读写里面的数据了。

文件描述符层：进程可以申请并通过文件描述符来访问 Unix 资源（文件、管道、设备等），文件只是其中之一。

所以这个层次结构只是站在磁盘上文件访问的视角。还应该有其他分支，如管道、设备。只不过它们都是在文件描述符层那里分叉的，而且应该只是一个叶子。

## 磁盘整体存储布局

Block0：bootloader

Block1：超级块，保存文件系统整体的元数据

接下来是日志区域，由于是 WAL，要先将块的修改记录写到磁盘上，然后再实际修改磁盘上的块；

接下来是 inode 区域，区域中的每个块保存多个 inode；

接下来是 bitmap 区域，保存数据块的使用情况；

剩下的块都是数据块。

后面的内容我们先不细看，还是等做文件系统的 lab 的时候吧。



