---
marp: true
paginate: true
theme: default
---
# QAQ，为什么啊
---

## 张译仁
* 清华大学
* 计算机系博一
* zyr_ms@outlook.com
* 4/25/2021

---
# Outline
## **OS 实验概况**
## 特色：“完备”
## 特色：“开放”
## 特色：“精简”
## 练习与其他
---
# OS 实验概况

rCore-Tutorial-v3 / uCore-Tutorial

* 2021 spring 本科 os 实验框架
* 特色：
  * “完备”：每个 chapter 都是一个可以支持用户程序的完整 os
  * “开放”：只有少数配置文件不可修改，不对实现做过多提示 / 约束
  * 精简：适量的封装，简单的逻辑，可控的代码行数

---

## 成功课改经验

实验内容：

* ucore: 
  boot => 内存管理 => 线程与调度 => 同步互斥 => 文件系统  
* r/uCore-v3: 
  boot => write => yield => mmap => pipe => open/read/write

实验形式:

* ucore: 填空式补全一个 OS
* r/uCore-v3: “从零开始写一个 OS”

实验框架与难度：

* ucore：完善但复杂的框架，难度较低
* r/uCore-v3: 精简且基础的框架，开发要求很低

---
# Outline
## OS 实验概况
## **特色：“完备”**
## 特色：“开放”
## 特色：“精简”
## 练习与其他
---
# 特色：“完备”

* 7 个章节都可以支持用户程序

* 功能增强直观反映在 syscall 的渐增

* 一定程度上完成了对 OS 历史的还原

---

## lab1 - 3

lab1：应用程序与基本执行环境
* boot + 串口输出
* 无 syscall

lab2: 批处理系统

* 用户态支持
* sys_write\*，sys_exit

lab3: 多道程序与分时多任务

* 任务调度与时钟中断
* sys_gettime，sys_yield

---

## lab 4 - 6

lab4: 地址空间

* 支持页机制，完成虚实地址管理
* sys_mmap\*[练习], sys_munmap\*[练习]

lab5: 进程及进程管理

* 完整的进程管理机制，shell
* fork, exec, getpid, sys_read\*

lab6: 进程间通信

* 支持 pipe，文件系统初步
* sys_pipe, sys_write，sys_read，sys_close

---

## lab 7-8

lab7: 文件系统与 IO 重定向

* virtio 文件系统支持
* sys_open, sys_dup, sys_linkat[练习], sys_unlinkat[练习]

lab8: 综合优化与性能提升

* 半开放实验，更加逼近真实 os
* 极端 / 恶意的测例
---
# Outline
## OS 实验概况
## 特色：“完备”
## **特色：“开放”**
## 特色：“精简”
## 练习与其他
---

# 特色：“开放”

需要填空的 ucore:

* 约定好的接口和功能，可修改部分极度受限 => 管中窥豹，盲人摸象

初心：从零开始写一个 os

* 基础但全面的了解

* ~~本科必做实验~~

---

## 特色：“开放”

自由的 rCore-Tutorial-v3:

* 在 syscall 层级提出要求
* 不对实现做过多约束与提示

* 除了 Makefile 和基础配置文件外，可以随意改动框架

=>

* 需要结合指导书理解框架代码，自行总结解决方案。
* 五花八门的实现：
  * 修改高层接口 vs 重组底层接口
  * 严谨的高效实现 vs 取巧的"错误" 的实现

---
# Outline
## OS 实验概况
## 特色：“完备”
## 特色：“开放”
## **特色：“精简”**
## 练习与其他
---

# 特色：精简

开放带来的挑战：对框架代码的理解

* OS 理论知识
* 代码 / 文档阅读能力

课程结构的调整：课堂内容与实验内容基本同步并领先

精心编写的指导书 + 容易读懂的代码

---

## 可控的行数

uCore-Tutorial:

| lab  | file | blank | comment | code | diff |
| :--: | :--: | :---: | :-----: | :--: | :--: |
| ch1  |  6   |  21   |    2    | 156  | 156  |
| ch2  |  11  |  65   |   54    | 437  | 299  |
| ch3  |  14  |  92   |   72    | 609  | 240  |
| ch4  |  16  |  136  |   131   | 909  | 370  |
| ch5  |  16  |  166  |   148   | 1147 | 310  |
| ch6  |  18  |  181  |   149   | 1367 | 228  |
| ch7  |  23  |  309  |   355   | 2157 | 889  |

---

## 可控的行数

rCore-Tutorial-v3:

| lab  | file | blank | comment | code |  diff  |
| :--: | :--: | :---: | :-----: | :--: | :----: |
| ch1  |  6   |  33   |    0    | 272  |  272   |
| ch2  |  13  |  65   |   18    | 512  |  277   |
| ch3  |  20  |  93   |   27    | 708  |  318   |
| ch4  |  26  |  146  |   56    | 1565 | 952(*) |
| ch5  |  29  |  180  |   128   | 1991 |  591   |
| ch6  |  32  |  201  |   134   | 2290 |  338   |
| ch7  |  36  |  266  |   363   | 3124 |  921   |

---

## 易读的代码

简单的算法与数据结构

* 进程调度：~~CFS + 红黑树~~ RR + 向量
* 内存管理：~~SLAB~~ 预分配 + 基于页的粗放管理，~~COW + pg~~ 直接的拷贝

实际效果：

* 能力较强的同学可以脱离指导书完成实验
* 大部分同学表示基本看懂框架代码
---
# Outline
## OS 实验概况
## 特色：“完备”
## 特色：“开放”
## 特色：“精简”
## **练习与其他**
---
---

# 练习题目

* 编程 + 思考题
* 编程要求较低，主要目的是促进同学对框架的整体把握。
  * sys_mmap: 物理内存管理和虚拟内存管理接口都已经提供
* 思考题目补充难度较高的知识
  * 缺页 / COW
  * 多 CPU 与锁
* 安全性与严谨性
  * 每一章都有错误处理有关测例
  * lab8 是对安全性的综合测试

---

# 不足

出现的问题：

* 章节难度差异明显
* 代码注释不足，依赖指导书
* 框架兼容性差，依赖工具链版本，C框架存在 bug
* 指导书部分内容有待改进

---

# 展望

未来的改进：

![path](path.png)

